<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Copa 2 – Caça-Níquel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.7.0/css/flag-icon.min.css">
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(#74d300, #179800);
      font-family: sans-serif;
      text-align: center;
    }
    #app {
      max-width: 360px;
      margin: 10px auto;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 15px #000;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      background: #222;
      color: #fff;
      font-weight: bold;
      font-size: 12px;
      padding: 6px 10px;
    }
    .top-bar span {
      background: #444;
      padding: 3px 6px;
      border-radius: 5px;
      color: yellow;
    }
    #board {
      display: grid;
      grid-template-areas:
        "tl t1 t2 t3 t4 tr"
        "l1 btn btn btn btn r1"
        "l2 btn btn btn btn r2"
        "l3 btn btn btn btn r3"
        "bl b4 b3 b2 b1 br";
      gap: 2px;
      margin-top: 8px;
    }
    .slot {
      background: white;
      border: 2px solid #333;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 45px;
      height: 45px;
      pointer-events: none;
    }
    .center-image {
      grid-area: btn;
      display: flex;
      justify-content: center;
      align-items: center;
      background: black;
    }
    .center-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #btnPlay {
      margin-top: 10px;
      width: 100%;
      height: 40px;
      background: red;
      border: none;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 8px;
    }
    #btnPlay:disabled {
      background: grey;
      cursor: not-allowed;
    }
    #btnPlay:active {
      animation: pulse 0.2s;
    }
    #menu {
      background: #111;
      color: white;
      padding: 8px;
    }
    .flag-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .blink {
      animation: brilho 0.3s infinite alternate;
      box-shadow: 0 0 10px gold;
    }
    @keyframes brilho {
      from { border-color: gold; }
      to { border-color: red; }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-3px); }
      75% { transform: translateX(3px); }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    #betList {
      margin-top: 8px;
      background: #222;
      color: #fff;
      padding: 6px;
      border-radius: 6px;
      display: none;
    }
    #teamButtons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 4px;
      margin-top: 8px;
      display: none;
    }
    .teamButton {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid #fff;
      background: #333;
      padding: 0;
      cursor: pointer;
      overflow: hidden;
      transition: transform 0.2s;
    }
    .teamButton img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .teamButton:hover {
      transform: scale(1.1);
    }
    .teamButton:active {
      animation: shake 0.2s;
    }
    .bet-item {
      display: inline-block;
      width: 40px;
      margin: 2px;
      background: #000;
      border: 1px solid #fff;
      border-radius: 4px;
      padding: 2px;
      cursor: pointer;
    }
    .bet-item:hover {
      border-color: red;
    }
    #betAmount {
      display: none;
    }
    #pixButton {
      margin-top: 8px;
      width: 100%;
      height: 35px;
      background: #00cc00;
      border: 1px solid #fff;
      color: white;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
      transition: transform 0.2s;
    }
    #pixButton:hover {
      transform: scale(1.05);
    }
    #pixPaymentContainer {
      margin-top: 10px;
      background: #222;
      padding: 10px;
      border-radius: 6px;
    }
    #pixPaymentContainer img {
      max-width: 200px;
      margin: 10px auto;
      display: block;
    }
    #pixPaymentContainer textarea {
      width: 100%;
      height: 60px;
      background: #333;
      color: #fff;
      border: 1px solid #fff;
      border-radius: 4px;
      padding: 5px;
      font-size: 12px;
    }
    #creditMenu {
      width: 100%;
      margin: 8px 0;
      padding: 5px;
      background: #333;
      color: white;
      border: 1px solid #fff;
      border-radius: 4px;
    }
    #resetButton {
      margin-top: 8px;
      width: 100%;
      height: 35px;
      background: #444;
      border: 1px solid #fff;
      color: white;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 6px;
      display: none;
    }
    #gameStatus {
      margin-top: 8px;
      color: white;
      font-size: 14px;
    }
    .painel {
      margin-top: 10px;
      background: #222;
      padding: 10px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .saldo {
      color: white;
      font-size: 14px;
    }
    .btn-saque {
      background: #00cc00;
      border: 1px solid #fff;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-saque:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body>
<div id="app">
  <div class="top-bar">
    <div>PRÊMIO: <span id="prize">0</span></div>
    <div>CRÉDITOS: <span id="credits">0</span></div>
  </div>
  <div id="board">
    <div class="slot" style="grid-area:tl"><img src="imagens/br.png" class="flag-img" data-team="br"></div>
    <div class="slot" style="grid-area:t1"><img src="imagens/de.png" class="flag-img" data-team="de"></div>
    <div class="slot" style="grid-area:t2"><img src="imagens/fr.png" class="flag-img" data-team="fr"></div>
    <div class="slot" style="grid-area:t3"><img src="imagens/es.png" class="flag-img" data-team="es"></div>
    <div class="slot" style="grid-area:t4"><img src="imagens/it.png" class="flag-img" data-team="it"></div>
    <div class="slot" style="grid-area:tr"><img src="imagens/pt.png" class="flag-img" data-team="pt"></div>
    <div class="slot" style="grid-area:l1"><img src="imagens/nl.png" class="flag-img" data-team="nl"></div>
    <div class="slot" style="grid-area:l2"><img src="imagens/gb.png" class="flag-img" data-team="gb"></div>
    <div class="slot" style="grid-area:l3"><img src="imagens/ar.png" class="flag-img" data-team="ar"></div>
    <div class="slot" style="grid-area:r1"><img src="imagens/mx.png" class="flag-img" data-team="mx"></div>
    <div class="slot" style="grid-area:r2"><img src="imagens/us.png" class="flag-img" data-team="us"></div>
    <div class="slot" style="grid-area:r3"><img src="imagens/co.png" class="flag-img" data-team="co"></div>
    <div class="slot" style="grid-area:bl"><img src="imagens/jp.png" class="flag-img" data-team="jp"></div>
    <div class="slot" style="grid-area:b4"><img src="imagens/kr.png" class="flag-img" data-team="kr"></div>
    <div class="slot" style="grid-area:b3"><img src="imagens/ch.png" class="flag-img" data-team="ch"></div>
    <div class="slot" style="grid-area:b2"><img src="imagens/uy.png" class="flag-img" data-team="uy"></div>
    <div class="slot" style="grid-area:b1"><img src="imagens/pe.png" class="flag-img" data-team="pe"></div>
    <div class="slot" style="grid-area:br"><img src="imagens/ca.png" class="flag-img" data-team="ca"></div>
    <div class="center-image">
      <img src="https://blog.bdfutbol.com/wp-content/uploads/2024/04/DALL%C2%B7E-2024-04-02-15.20.22-Imagine-a-vibrant-and-dynamic-scene-capturing-the-essence-of-Belgian-soccer-for-the-introduction-of-the-Belgian-soccer-league-to-BDFutbol.-The-image-f.jpg">
    </div>
  </div>
  <button id="btnPlay" disabled>JOGAR</button>
  <div id="menu">
    <label>Escolher Pacote de Créditos:</label>
    <select id="creditMenu">
      <option value="option1" data-credits="10" data-attempts="3">R$10 - 10 Créditos, 3 Tentativas</option>
      <option value="option2" data-credits="20" data-attempts="5">R$20 - 20 Créditos, 5 Tentativas</option>
      <option value="option3" data-credits="50" data-attempts="10">R$50 - 50 Créditos, 10 Tentativas</option>
    </select>
    <button onclick="generatePixPayment()">Gerar Pix</button>
    <div id="pixPaymentContainer"></div>
    <hr>
    <label>Escolher Time:</label>
    <div id="teamButtons">
      <button class="teamButton" data-team="br"><img src="imagens/br.png" alt="Corinthians"></button>
      <button class="teamButton" data-team="de"><img src="imagens/de.png" alt="Vitória"></button>
      <button class="teamButton" data-team="fr"><img src="imagens/fr.png" alt="Vasco"></button>
      <button class="teamButton" data-team="es"><img src="imagens/es.png" alt="São Paulo"></button>
      <button class="teamButton" data-team="it"><img src="imagens/it.png" alt="Santos"></button>
      <button class="teamButton" data-team="pt"><img src="imagens/pt.png" alt="Flamengo"></button>
      <button class="teamButton" data-team="nl"><img src="imagens/nl.png" alt="Ponte Preta"></button>
      <button class="teamButton" data-team="gb"><img src="imagens/gb.png" alt="Palmeiras"></button>
      <button class="teamButton" data-team="ar"><img src="imagens/ar.png" alt="Atlético Paranaense"></button>
      <button class="teamButton" data-team="mx"><img src="imagens/mx.png" alt="Internacional"></button>
      <button class="teamButton" data-team="us"><img src="imagens/us.png" alt="Cruzeiro"></button>
      <button class="teamButton" data-team="co"><img src="imagens/co.png" alt="Botafogo"></button>
      <button class="teamButton" data-team="jp"><img src="imagens/jp.png" alt="Fluminense"></button>
      <button class="teamButton" data-team="kr"><img src="imagens/kr.png" alt="Campinense"></button>
      <button class="teamButton" data-team="ch"><img src="imagens/ch.png" alt="Juventude"></button>
      <button class="teamButton" data-team="uy"><img src="imagens/uy.png" alt="Grêmio"></button>
      <button class="teamButton" data-team="pe"><img src="imagens/pe.png" alt="Goiás"></button>
      <button class="teamButton" data-team="ca"><img src="imagens/ca.png" alt="Coritiba"></button>
    </div>
    <input type="number" id="betAmount" placeholder="1-5" min="1" max="5">
    <div id="betList"></div>
    <button id="resetButton">Reiniciar Jogo</button>
    <div id="gameStatus"></div>
  </div>
  <div class="painel">
    <div class="saldo">Saldo: R$ <span id="saldo">0</span></div>
    <button class="btn-saque" onclick="mostrarMensagem()">💸 Solicitar Saque</button>
  </div>
  <!-- Elementos de áudio -->
  <audio id="backgroundSound" src="sons/background.mp3" loop autoplay></audio>
  <audio id="clickSound" src="sons/click.mp3"></audio>
  <audio id="spinSound" src="sons/spin.mp3"></audio>
  <audio id="winSound" src="sons/win.mp3"></audio>
  <audio id="loseSound" src="sons/lose.mp3"></audio>
</div>
<script>
  // Initialize Mercado Pago
  const mp = new MercadoPago('SUA_PUBLIC_KEY_AQUI', { locale: 'pt-BR' });

  let credits = 0;
  let prize = parseInt(localStorage.getItem('prize')) || 0;
  let bets = {};
  let attempts = 0;
  let paymentId = null;
  const userId = 'default_user';
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzx14c3vBzTMfJag5EoraiWeSYquV5-_TSDiLLSC2lnoduVPOVtk18llvkO03hhv_VewA/exec';

  const creditsEl = document.getElementById('credits');
  const prizeEl = document.getElementById('prize');
  const saldoEl = document.getElementById('saldo');
  const btnPlay = document.getElementById('btnPlay');
  const slots = Array.from(document.querySelectorAll('.slot'));
  const betList = document.getElementById('betList');
  const teamButtons = document.querySelectorAll('.teamButton');
  const pixButton = document.getElementById('pixButton');
  const creditMenu = document.getElementById('creditMenu');
  const resetButton = document.getElementById('resetButton');
  const gameStatus = document.getElementById('gameStatus');
  const backgroundSound = document.getElementById('backgroundSound');
  const clickSound = document.getElementById('clickSound');
  const spinSound = document.getElementById('spinSound');
  const winSound = document.getElementById('winSound');
  const loseSound = document.getElementById('loseSound');

  // Set background sound volume
  backgroundSound.volume = 0.2;

  // Start background sound on first interaction
  document.addEventListener('click', () => {
    backgroundSound.play().catch(() => {});
  }, { once: true });

  function updateDisplay() {
    creditsEl.textContent = credits;
    prizeEl.textContent = prize;
    saldoEl.textContent = prize;
    btnPlay.disabled = credits <= 0 || attempts <= 0;
    gameStatus.textContent = attempts > 0 ? `Tentativas restantes: ${attempts}` : 'Jogo finalizado. Escolha um novo pacote para continuar.';
    betList.style.display = attempts > 0 ? 'block' : 'none';
    teamButtons.forEach(btn => btn.style.display = attempts > 0 ? 'inline-block' : 'none');
    resetButton.style.display = attempts <= 0 ? 'block' : 'none';

    betList.innerHTML = Object.entries(bets).map(([team, val]) => {
      return `
        <div class="bet-item" data-team="${team}" style="display: inline-block; width: 40px; margin: 2px; background: #000; border: 1px solid #fff; border-radius: 4px; padding: 2px;">
          <img src="imagens/${team}.png" style="width: 100%; height: 24px; object-fit: contain;">
          <div style="color: yellow; font-size: 10px;">${val}</div>
        </div>
      `;
    }).join('');

    document.querySelectorAll('.bet-item').forEach(item => {
      item.addEventListener('click', () => {
        const team = item.dataset.team;
        removeBet(team);
      });
    });
  }

  function save() {
    localStorage.setItem('credits', credits);
    localStorage.setItem('prize', prize);
  }

  async function resetGame() {
    credits = 0;
    attempts = 0;
    bets = {};
    paymentId = null;
    try {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'resetCredits', userId: userId })
      });
      const data = await response.json();
      if (!data.success) {
        console.error('Erro ao resetar créditos:', data.message);
        alert('Erro ao resetar o jogo. Tente novamente.');
      }
    } catch (error) {
      console.error('Erro na requisição de reset:', error);
      alert('Erro de conexão ao resetar o jogo. Verifique sua internet.');
    }
    creditMenu.style.display = 'block';
    pixButton.style.display = 'block';
    document.getElementById('pixPaymentContainer').innerHTML = '';
    gameStatus.textContent = 'Escolha um pacote de créditos para começar.';
    betList.style.display = 'none';
    teamButtons.forEach(btn => btn.style.display = 'none');
    resetButton.style.display = 'none';
    btnPlay.disabled = true;
    slots.forEach(slot => slot.style.pointerEvents = 'none');
    updateDisplay();
  }

  async function generatePixPayment() {
    const selectedOption = creditMenu.value;
    if (!selectedOption) {
      alert('Selecione um pacote de créditos');
      return;
    }

    try {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'generatePix', creditOption: selectedOption, userId: userId })
      });
      const data = await response.json();
      if (!data.success) {
        console.error('Erro ao gerar Pix:', data.message, data.details);
        alert(data.message || 'Erro ao gerar pagamento');
        return;
      }

      paymentId = data.paymentId;
      const pixContainer = document.getElementById('pixPaymentContainer');
      pixContainer.innerHTML = `
        <p>Escaneie o QR Code para pagar:</p>
        <img src="data:image/png;base64,${data.qrCodeBase64}" alt="QR Code Pix">
        <p>Ou use o código Copia e Cola:</p>
        <textarea readonly>${data.pixKey}</textarea>
        <button onclick="copyPixKey()">Copiar Chave Pix</button>
      `;
      checkPayment();
    } catch (error) {
      console.error('Erro na requisição de Pix:', error);
      alert('Erro de conexão ao gerar Pix. Verifique sua internet.');
    }
  }

  function copyPixKey() {
    const pixKey = document.querySelector('#pixPaymentContainer textarea');
    pixKey.select();
    document.execCommand('copy');
    alert('Chave Pix copiada!');
  }

  async function checkPayment() {
    if (!paymentId) return;

    const interval = setInterval(async () => {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'verifyPayment', paymentId })
        });
        const data = await response.json();
        if (data.success && data.status === 'approved') {
          clearInterval(interval);
          const creditsData = await fetchCredits();
          credits = parseInt(creditsData.credits);
          attempts = parseInt(creditsData.attempts);
          save();
          enableBoard();
          alert('Pagamento confirmado! Jogo liberado.');
          document.getElementById('pixPaymentContainer').innerHTML = '';
        } else if (!data.success) {
          console.error('Erro ao verificar pagamento:', data.message, data.details);
        }
      } catch (error) {
        console.error('Erro na requisição de verificação:', error);
      }
    }, 5000);
  }

  async function fetchCredits() {
    try {
      const response = await fetch(`${SCRIPT_URL}?action=getCredits&userId=${userId}`);
      const data = await response.json();
      if (!data.success) {
        console.error('Erro ao buscar créditos:', data.message);
      }
      return data.success ? data : { credits: "0", attempts: "0" };
    } catch (error) {
      console.error('Erro na requisição de créditos:', error);
      return { credits: "0", attempts: "0" };
    }
  }

  function enableBoard() {
    slots.forEach(slot => slot.style.pointerEvents = 'auto');
    creditMenu.style.display = 'none';
    pixButton.style.display = 'none';
    betList.style.display = 'block';
    teamButtons.forEach(btn => btn.style.display = 'inline-block');
    updateDisplay();
  }

  function placeBet(team = null, val = null) {
    const selectedTeam = team || document.getElementById('betTeam')?.value;
    const betValue = val || parseInt(document.getElementById('betAmount').value);
    if (!selectedTeam || isNaN(betValue) || betValue < 1 || betValue > 5) return alert('Escolha time e valor de 1 a 5');
    if (!bets[selectedTeam] && Object.keys(bets).length >= 5) return alert('Máximo 5 times por rodada');
    const totalBet = (bets[selectedTeam] || 0) + betValue;
    if (totalBet > 5) return alert('Máximo 5 créditos por time');
    if (credits < betValue) return alert('Créditos insuficientes');

    bets[selectedTeam] = totalBet;
    credits -= betValue;
    clickSound.play().catch(() => {});
    save();
    updateDisplay();
  }

  function removeBet(team) {
    if (bets[team]) {
      bets[team] -= 1;
      credits += 1;
      if (bets[team] === 0) {
        delete bets[team];
      }
      clickSound.play().catch(() => {});
      save();
      updateDisplay();
    }
  }

  teamButtons.forEach(button => {
    button.addEventListener('click', () => {
      const team = button.dataset.team;
      const betValue = parseInt(document.getElementById('betAmount').value) || 1;
      placeBet(team, betValue);
    });
  });

  function mostrarMensagem() {
    alert('Você não possui saldo para retirada');
  }

  btnPlay.onclick = () => {
    if (credits <= 0) return alert('Adicione créditos para jogar');
    if (attempts <= 0) return alert('Sem tentativas restantes. Escolha um novo pacote.');
    if (Object.keys(bets).length === 0) return alert('Nenhuma aposta feita');
    btnPlay.disabled = true;
    attempts--;
    spinSound.play().catch(() => {});
    slots.forEach(s => s.classList.remove('blink'));
    let count = 0;
    const flashes = 20 + Math.floor(Math.random() * 10);
    const interval = setInterval(() => {
      slots.forEach(s => s.classList.remove('blink'));
      const idx = Math.floor(Math.random() * slots.length);
      slots[idx].classList.add('blink');
      if (++count > flashes) {
        clearInterval(interval);
        const winner = slots[idx].querySelector('img').dataset.team;
        let win = bets[winner] ? bets[winner] * 5 : 0;
        prize += win;
        credits += win;
        bets = {};
        save();
        updateDisplay();
        if (win) {
          winSound.play().catch(() => {});
          alert(`GANHOU ${win} CRÉDITOS!`);
        } else {
          loseSound.play().catch(() => {});
          alert('NÃO FOI DESSA VEZ');
        }
        if (attempts <= 0) {
          resetButton.style.display = 'block';
          slots.forEach(slot => slot.style.pointerEvents = 'none');
        }
        btnPlay.disabled = credits <= 0 || attempts <= 0;
      }
    }, 100);
  };

  resetButton.addEventListener('click', resetGame);

  // Load initial state
  fetchCredits().then(data => {
    credits = parseInt(data.credits);
    attempts = parseInt(data.attempts);
    if (attempts > 0) enableBoard();
    updateDisplay();
  });
</script>
</body>
</html>
